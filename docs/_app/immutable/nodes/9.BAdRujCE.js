var G=Object.defineProperty;var W=(o,i,t)=>i in o?G(o,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[i]=t;var r=(o,i,t)=>(W(o,typeof i!="symbol"?i+"":i,t),t);import{s as M,n as X,o as U,v as Z,b as P}from"../chunks/scheduler.iXXlly_q.js";import{S as _,i as Y,e as B,t as J,c as S,a as q,b as K,d as w,g as I,h as x,j as tt,l as D,s as E,m as T,f as $,k as st,n as F,o as H,p as O,q as V,u as R}from"../chunks/index.CGXjPJL2.js";import{V as p,M as et,a as it,b as nt,c as at,S as ot,O as rt,W as ht,C as ct}from"../chunks/three.module.DzU_tVEa.js";import{a as Q}from"../chunks/utils.B7PvQ2PK.js";function C(o,i){const t=o.x-i.x,s=o.y-i.y;return t*t+s*s}class L{}class g extends L{constructor(t,s,e,n){super();r(this,"centerX");r(this,"centerY");r(this,"width");r(this,"height");this.centerX=t,this.centerY=s,this.width=e,this.height=n}static fromTopLeft(t,s,e,n){return new g(t+e/2,s+n/2,e,n)}leftX(){return this.centerX-this.width/2}rightX(){return this.centerX+this.width/2}topY(){return this.centerY-this.height/2}bottomY(){return this.centerY+this.height/2}debugDirections(){return{left:this.leftX(),right:this.rightX(),top:this.topY(),bottom:this.bottomY()}}contains(t){const s=t.x,e=t.y;return this.leftX()<=s&&this.rightX()>=s&&this.topY()<=e&&this.bottomY()>=e}intersects(t){if(t instanceof g)return!(this.leftX()>t.rightX()||t.leftX()>this.rightX()||this.topY()>t.bottomY()||t.topY()>this.bottomY());if(t instanceof A){if(this.contains(t.center))return!0;const s={x:Math.max(this.leftX(),Math.min(this.rightX(),t.center.x)),y:Math.max(this.topY(),Math.min(this.bottomY(),t.center.y))};return C(t.center,s)<t.radius*t.radius}Q(t)}closestBoundaryPointToPoint(t,s){s.x=Math.max(this.leftX(),Math.min(t.x,this.rightX())),s.y=Math.max(this.topY(),Math.min(t.y,this.bottomY()))}sqDistanceToPoint(t){const s={x:0,y:0};this.closestBoundaryPointToPoint(t,s);const e=t.x-s.x,n=t.y-s.y;return e*e+n*n}}class A extends L{constructor(t,s){super();r(this,"center");r(this,"radius");this.center=t,this.radius=s}contains(t){return C(this.center,t)<this.radius*this.radius}intersects(t){if(t instanceof A){const s=this.radius+t.radius,e=s*s;return C(this.center,t.center)<e}if(t instanceof g)return t.intersects(this);Q(t)}closestBoundaryPointToPoint(t,s){const e=t.x-this.center.x,n=t.y-this.center.y,a=Math.sqrt(e*e+n*n);a<=1e-4&&(s.x=this.center.x,s.y=this.center.y);const c=this.radius/a;s.x=this.center.x+t.x*c,s.y=this.center.y+t.y*c}sqDistanceToPoint(t){const s=t.x-this.center.x,e=t.y-this.center.y,n=s*s+e*e;return Math.pow(Math.sqrt(n)-this.radius,2)}}class k{}class ut extends k{constructor(t){super();r(this,"elements",[]);r(this,"accessFunc");this.accessFunc=t}push(t){this.elements.push(t)}query(t){return this.elements.filter(s=>t.contains(this.accessFunc(s)))}queryAll(){return this.elements}rebalance(){}}class v extends k{constructor(t,s,e){super();r(this,"elements",[]);r(this,"accessFunc");r(this,"capacity");r(this,"boundaryBox");r(this,"subdivisions");this.accessFunc=s,this.capacity=e,this.boundaryBox=t}push(t){if(this.elements.length<=this.capacity){this.elements.push(t);return}if(typeof this.subdivisions>"u"&&(this.subdivisions={ne:new v(new g((this.boundaryBox.centerX+this.boundaryBox.rightX())/2,(this.boundaryBox.centerY+this.boundaryBox.topY())/2,this.boundaryBox.width/2,this.boundaryBox.height/2),this.accessFunc,this.capacity),nw:new v(new g((this.boundaryBox.centerX+this.boundaryBox.leftX())/2,(this.boundaryBox.centerY+this.boundaryBox.topY())/2,this.boundaryBox.width/2,this.boundaryBox.height/2),this.accessFunc,this.capacity),se:new v(new g((this.boundaryBox.centerX+this.boundaryBox.rightX())/2,(this.boundaryBox.centerY+this.boundaryBox.bottomY())/2,this.boundaryBox.width/2,this.boundaryBox.height/2),this.accessFunc,this.capacity),sw:new v(new g((this.boundaryBox.centerX+this.boundaryBox.leftX())/2,(this.boundaryBox.centerY+this.boundaryBox.bottomY())/2,this.boundaryBox.width/2,this.boundaryBox.height/2),this.accessFunc,this.capacity)}),this.subdivisions){let s=this.accessFunc(t).x<this.boundaryBox.centerX,e=this.accessFunc(t).y<this.boundaryBox.centerY;s&&e?this.subdivisions.nw.push(t):!s&&e?this.subdivisions.ne.push(t):s&&!e?this.subdivisions.sw.push(t):!s&&!e?this.subdivisions.se.push(t):this.subdivisions.nw.push(t)}}query(t){if(!t.intersects(this.boundaryBox))return[];let s=[];return this.elements.filter(e=>t.contains(this.accessFunc(e))).forEach(e=>s.push(e)),this.subdivisions&&(this.subdivisions.ne.query(t).filter(e=>t.contains(this.accessFunc(e))).forEach(e=>s.push(e)),this.subdivisions.nw.query(t).filter(e=>t.contains(this.accessFunc(e))).forEach(e=>s.push(e)),this.subdivisions.se.query(t).filter(e=>t.contains(this.accessFunc(e))).forEach(e=>s.push(e)),this.subdivisions.sw.query(t).filter(e=>t.contains(this.accessFunc(e))).forEach(e=>s.push(e))),s}queryAll(){let t=[];return this.elements.forEach(s=>t.push(s)),this.subdivisions&&(this.subdivisions.ne.queryAll().forEach(s=>t.push(s)),this.subdivisions.nw.queryAll().forEach(s=>t.push(s)),this.subdivisions.se.queryAll().forEach(s=>t.push(s)),this.subdivisions.sw.queryAll().forEach(s=>t.push(s))),t}rebalance(t){let s=t??this;if(this.elements.forEach((e,n)=>{this.boundaryBox.contains(this.accessFunc(e))||(this.elements.splice(n,1),s.push(e))}),this.subdivisions&&(this.subdivisions.ne.rebalance(s),this.subdivisions.nw.rebalance(s),this.subdivisions.se.rebalance(s),this.subdivisions.sw.rebalance(s)),this.subdivisions){let e=[this.subdivisions.ne,this.subdivisions.nw,this.subdivisions.se,this.subdivisions.sw],n=e.reduce((c,h)=>c+h.elements.length,0),a=e.every(c=>typeof c.subdivisions>"u");n===0&&a&&(this.subdivisions=void 0)}}}const dt={maxSpeed:3,minSpeed:2,neighborRange:20,protectedRange:2,obstacleRange:50,cohesionFactor:5e-4,separationFactor:.05,alignmentFactor:.05,turnFactor:.25,speedScale:1};class lt{constructor(i,t,s,e={}){r(this,"tooCloseBBox");r(this,"neighborsBBox");r(this,"position");r(this,"heading");r(this,"futureHeadingOffset");r(this,"params");r(this,"id");this.id=i,this.position=t,this.heading=s,this.futureHeadingOffset=s.clone(),this.params={...dt,...e},this.tooCloseBBox=new A(t,this.params.protectedRange),this.neighborsBBox=new A(t,this.params.neighborRange)}move(i){this.heading.copy(this.futureHeadingOffset).clampLength(this.params.minSpeed,this.params.maxSpeed).multiplyScalar(this.params.speedScale),this.position.addScaledVector(this.heading,i*60),this.tooCloseBBox.center=this.position,this.neighborsBBox.center=this.position}calculateNewHeading(i){this.futureHeadingOffset.copy(this.heading);let t=i.boidsQt.query(this.tooCloseBBox),s=i.boidsQt.query(this.neighborsBBox).filter(h=>!t.includes(h)),e=new p(0,0);t.forEach(h=>{e.add(this.position).sub(h.position)});let n=new p(0,0);s.length>0&&(s.forEach(h=>{n.add(h.heading)}),n.divideScalar(s.length));let a=new p(0,0);s.length>0&&(s.forEach(h=>{a.add(h.position)}),a.divideScalar(s.length));let c=new p;i.obstacles.forEach(h=>{let l=this.position.distanceToSquared(h.position),m=Math.pow(l,-h.inverseDistance)*h.attractiveStrength,f=this.position.clone().sub(h.position);c.addScaledVector(f,-m)}),this.futureHeadingOffset.addScaledVector(e,this.params.separationFactor),this.futureHeadingOffset.addScaledVector(n,this.params.alignmentFactor),this.futureHeadingOffset.addScaledVector(a,this.params.cohesionFactor),this.futureHeadingOffset.add(c),this.futureHeadingOffset.clampLength(this.params.minSpeed,this.params.maxSpeed)}getPosition(){return this.position}getVelocity(){return this.heading}updateParams(i){i.neighborRange&&(this.neighborsBBox.radius=i.neighborRange),i.protectedRange&&(this.tooCloseBBox.radius=i.protectedRange),this.params={...this.params,...i}}}class pt{constructor(i,t,s,e){r(this,"QT_CAPACITY",50);r(this,"boidsQt");r(this,"boidsSprites",[]);r(this,"worldArea");r(this,"frameCount",0);r(this,"obstacles",[]);r(this,"curId",0);this.worldArea=new g(i,t,s*2,e*2),this.boidsQt=new v(this.worldArea,n=>n.getPosition(),this.QT_CAPACITY),this.addObstacle({position:new p(i,t),attractiveStrength:6e-8,inverseDistance:-1}),this.addObstacle({position:new p(i-s/6,t),attractiveStrength:-1e-9,inverseDistance:1}),this.addObstacle({position:new p(i+s/6,t),attractiveStrength:-1e-9,inverseDistance:1})}addBoid(i,t){let s=new lt(this.curId++,i,t);this.boidsQt.push(s);let e=ft();const n=new et({color:16777215,opacity:.6,transparent:!0});let a=new it(e,n);a.position.x=i.x,a.position.y=i.y,a.rotateZ(t.angle()),this.boidsSprites.push(a)}updateHeadings(){this.boidsQt.queryAll().forEach(i=>{i.calculateNewHeading(this)})}move(i){if(this.frameCount++,this.boidsQt.queryAll().forEach(t=>{t.move(i),this.boidsSprites[t.id].position.x=t.getPosition().x,this.boidsSprites[t.id].position.y=t.getPosition().y,this.boidsSprites[t.id].rotation.z=t.getVelocity().angle()}),this.frameCount%180===0){let t=this.boidsQt.queryAll();this.boidsQt=new v(this.worldArea,s=>s.getPosition(),this.QT_CAPACITY),t.forEach(s=>this.boidsQt.push(s))}else this.boidsQt.rebalance()}update(i){this.updateHeadings(),this.move(i)}addObstacle(i){this.obstacles.push(i)}destroy(){this.boidsQt=new ut(i=>i.getPosition()),this.boidsSprites=[]}}function ft(){let o=new nt;const i=-.8,t=Math.sin(Math.acos(i)),s=1;let e=new p(1,0).multiplyScalar(s),n=new p(i,t).multiplyScalar(s),a=new p(i,-t).multiplyScalar(s);return o.moveTo(e.x,e.y),o.lineTo(n.x,n.y),o.lineTo(a.x,a.y),new at(o)}function mt(o,i,t,s=2){let e=new ot;const n=o/i,a=i/s;let c=new rt(-a*n/2,a*n/2,a/2,-a/2,1,1e3);c.position.z=10;let h=new ht({canvas:t});return h.setSize(o,i),{scene:e,camera:c,renderer:h}}function yt(o,i,t,s,e){const n=()=>{requestAnimationFrame(n);let a=e.getDelta();o({camera:s,scene:t,renderer:i,deltatime:a}),i.render(t,s)};return n}class bt extends _{constructor(i){super(),Y(this,i,null,null,M,{})}}class gt{constructor(i){r(this,"capacity");r(this,"head",0);r(this,"tail",0);r(this,"array");r(this,"occupancy",0);this.capacity=i,this.array=new Array(i)}push(i){this.occupancy===this.capacity&&(this.occupancy-=1,this.head=(this.head+1)%this.capacity),this.array[this.tail]=i,this.tail=(this.tail+1)%this.capacity,this.occupancy+=1}pop(){if(this.occupancy===0)return null;const i=this.array[this.head];return this.head=(this.head+1)%this.capacity,this.occupancy-=1,i}peek(){return this.occupancy===0?null:this.array[this.head]}map(i){let t=this.head,s=new Array(this.occupancy);for(let e=0;e<this.occupancy;++e)s[e]=i(this.array[t]),t=(t+1)%this.capacity;return s}reduce(i,t){let s=this.head;for(let e=0;e<this.occupancy;++e)t=i(t,this.array[s]),s=(s+1)%this.capacity;return t}toArray(){return[...this.array.slice(this.head),...this.array.slice(void 0,this.tail)]}}class vt extends gt{constructor(){super(...arguments);r(this,"_sum",0)}mean(){return this.occupancy>0?this.sum()/this.occupancy:null}sum(){return this.reduce((t,s)=>t+s,0)}}function xt(o){let i,t=Math.round(1/(o[0].mean()??-1))+"",s;return{c(){i=B("div"),s=J(t)},l(e){i=S(e,"DIV",{});var n=q(i);s=K(n,t),n.forEach(w)},m(e,n){I(e,i,n),x(i,s)},p(e,[n]){n&1&&t!==(t=Math.round(1/(e[0].mean()??-1))+"")&&tt(s,t)},i:X,o:X,d(e){e&&w(i)}}}function wt(o,i,t){let s=new vt(10);function e(n){s.push(n),t(0,s)}return[s,e]}class Bt extends _{constructor(i){super(),Y(this,i,wt,xt,M,{pushDeltatime:1})}get pushDeltatime(){return this.$$.ctx[1]}}function St(o){let i,t,s,e,n,a,c="",h,l,m,f={};return e=new Bt({props:f}),o[2](e),l=new bt({}),{c(){i=B("div"),t=B("div"),s=B("div"),D(e.$$.fragment),n=E(),a=B("canvas"),a.innerHTML=c,h=E(),D(l.$$.fragment),this.h()},l(u){i=S(u,"DIV",{});var y=q(i);t=S(y,"DIV",{class:!0});var d=q(t);s=S(d,"DIV",{class:!0});var b=q(s);T(e.$$.fragment,b),b.forEach(w),n=$(d),a=S(d,"CANVAS",{class:!0,"data-svelte-h":!0}),st(a)!=="svelte-1p8lv0v"&&(a.innerHTML=c),d.forEach(w),h=$(y),T(l.$$.fragment,y),y.forEach(w),this.h()},h(){F(s,"class","absolute z-10 select-none text-white"),F(a,"class","relative"),F(t,"class","relative")},m(u,y){I(u,i,y),x(i,t),x(t,s),H(e,s,null),x(t,n),x(t,a),o[3](a),x(i,h),H(l,i,null),m=!0},p(u,[y]){const d={};e.$set(d)},i(u){m||(O(e.$$.fragment,u),O(l.$$.fragment,u),m=!0)},o(u){V(e.$$.fragment,u),V(l.$$.fragment,u),m=!1},d(u){u&&w(i),o[2](null),R(e),o[3](null),R(l)}}}const At=350;function qt(o,i,t){let s,e,n,a,c,h,l,m,f;U(()=>{l=800,m=600,{camera:e,renderer:n,scene:a}=mt(l,m,s,2),console.log("camera boundaries: ",{top:e.top,bottom:e.bottom,left:e.left,right:e.right}),f=new pt(0,0,e.right-e.left,e.top-e.bottom);for(let b=0;b<At;++b){let z=Math.random()*(e.right-e.left)+e.left,N=Math.random()*(e.top-e.bottom)+e.bottom,j=new p(z,N);f.addBoid(j,new p(Math.random(),Math.random()))}a.add(...f.boidsSprites),c=new ct,yt(b=>{b.deltatime>0&&(h.pushDeltatime(b.deltatime),f.update(Math.min(b.deltatime,1/15)))},n,a,e,c)()}),Z(()=>{f&&f.destroy(),a&&a.clear(),c&&c.stop()});function u(d){P[d?"unshift":"push"](()=>{h=d,t(1,h)})}function y(d){P[d?"unshift":"push"](()=>{s=d,t(0,s)})}return[s,h,u,y]}class Xt extends _{constructor(i){super(),Y(this,i,qt,St,M,{})}}export{Xt as component};
