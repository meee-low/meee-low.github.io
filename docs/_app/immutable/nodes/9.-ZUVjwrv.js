var P=Object.defineProperty;var M=(r,s,t)=>s in r?P(r,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[s]=t;var a=(r,s,t)=>(M(r,typeof s!="symbol"?s+"":s,t),t);import{s as Y,n as b,o as q,b as X}from"../chunks/scheduler.iXXlly_q.js";import{S as T,i as F,e as R,c as H,a as I,d as w,g as D}from"../chunks/index.CGXjPJL2.js";import{M as Q,a as V,b as _,V as d,c as E,S as k,O as L,W as j}from"../chunks/three.module.DGVNqpL6.js";import{a as B}from"../chunks/utils.B7PvQ2PK.js";function y(r,s){const t=r.x-s.x,e=r.y-s.y;return t*t+e*e}class v{}class l extends v{constructor(t,e,i,o){super();a(this,"centerX");a(this,"centerY");a(this,"width");a(this,"height");this.centerX=t,this.centerY=e,this.width=i,this.height=o}static fromTopLeft(t,e,i,o){return new l(t+i/2,e+o/2,i,o)}leftX(){return this.centerX-this.width/2}rightX(){return this.centerX+this.width/2}topY(){return this.centerY-this.height/2}bottomY(){return this.centerY+this.height/2}debugDirections(){return{left:this.leftX(),right:this.rightX(),top:this.topY(),bottom:this.bottomY()}}contains(t){const e=t.x,i=t.y;return this.leftX()<=e&&this.rightX()>=e&&this.topY()<=i&&this.bottomY()>=i}intersects(t){if(t instanceof l)return!(this.leftX()>t.rightX()||t.leftX()>this.rightX()||this.topY()>t.bottomY()||t.topY()>this.bottomY());if(t instanceof p){if(this.contains(t.center))return!0;const e={x:Math.max(this.leftX(),Math.min(this.rightX(),t.center.x)),y:Math.max(this.topY(),Math.min(this.bottomY(),t.center.y))};return y(t.center,e)<t.radius*t.radius}B(t)}closestBoundaryPointToPoint(t,e){e.x=Math.max(this.leftX(),Math.min(t.x,this.rightX())),e.y=Math.max(this.topY(),Math.min(t.y,this.bottomY()))}sqDistanceToPoint(t){const e={x:0,y:0};this.closestBoundaryPointToPoint(t,e);const i=t.x-e.x,o=t.y-e.y;return i*i+o*o}}class p extends v{constructor(t,e){super();a(this,"center");a(this,"radius");this.center=t,this.radius=e}contains(t){return y(this.center,t)<this.radius*this.radius}intersects(t){if(t instanceof p){const e=this.radius+t.radius,i=e*e;return y(this.center,t.center)<i}if(t instanceof l)return t.intersects(this);B(t)}closestBoundaryPointToPoint(t,e){const i=t.x-this.center.x,o=t.y-this.center.y,n=Math.sqrt(i*i+o*o);n<=1e-4&&(e.x=this.center.x,e.y=this.center.y);const h=this.radius/n;e.x=this.center.x+t.x*h,e.y=this.center.y+t.y*h}sqDistanceToPoint(t){const e=t.x-this.center.x,i=t.y-this.center.y,o=e*e+i*i;return Math.pow(Math.sqrt(o)-this.radius,2)}}class u{constructor(s,t,e){a(this,"elements",[]);a(this,"subdivisions");a(this,"accessCoordinate");a(this,"capacity");a(this,"boundaryBox");this.accessCoordinate=t,this.capacity=e,this.boundaryBox=s}subdivide(){let s=[];const t=this.boundaryBox.width/2,e=this.boundaryBox.height/2;for(let i=-1/2;i<=1/2;i+=1){const o=this.boundaryBox.centerY+i*this.boundaryBox.height;for(let n=-1/2;n<=1/2;n+=1){const h=this.boundaryBox.centerX+n*this.boundaryBox.width,c=new l(h,o,t,e);s.push(c)}}this.subdivisions={nw:new u(s[0],this.accessCoordinate,this.capacity),ne:new u(s[1],this.accessCoordinate,this.capacity),sw:new u(s[2],this.accessCoordinate,this.capacity),se:new u(s[3],this.accessCoordinate,this.capacity)}}push(s){const t=this.accessCoordinate(s);return this.boundaryBox.contains(t)?this.pushUnchecked(s):!1}pushUnchecked(s){return this.elements.length<this.capacity?(this.elements.push(s),!0):this.addToMatchingChild(s)}addToMatchingChild(s){const t=this.accessCoordinate(s);this.subdivisions||this.subdivide();let e;const i=[t.x>this.boundaryBox.centerX,t.y>this.boundaryBox.centerY];if(i[0]===!1&&i[1]===!1)e="nw";else if(i[0]===!0&&i[1]===!1)e="ne";else if(i[0]===!1&&i[1]===!0)e="sw";else if(i[0]===!0&&i[1]===!0)e="se";else throw new Error("This should never happen.");return this.subdivisions[e].pushUnchecked(s)}query(s){let t=[];return this.queryImpl(s,t)}queryImpl(s,t){if(!s.intersects(this.boundaryBox))return t;for(const e of this.elements)s.contains(this.accessCoordinate(e))&&t.push(e);if(this.subdivisions)for(const e of Object.values(this.subdivisions))e.queryImpl(s,t);return t}queryAll(){return this.query(this.boundaryBox)}}const N={maxSpeed:3,minSpeed:2,neighborRange:20,protectedRange:2,obstacleRange:50,cohesionFactor:5e-4,separationFactor:.05,alignmentFactor:.05,turnFactor:.2};class U{constructor(s,t,e,i={}){a(this,"tooCloseBBox");a(this,"neighborsBBox");a(this,"position");a(this,"heading");a(this,"futureHeading");a(this,"params");a(this,"id");this.id=s,this.position=t,this.heading=e,this.futureHeading=e,this.params={...N,...i},this.tooCloseBBox=new p(t,this.params.protectedRange),this.neighborsBBox=new p(t,this.params.neighborRange)}move(){this.heading=this.futureHeading.clampLength(this.params.minSpeed,this.params.maxSpeed),this.position.add(this.heading),this.tooCloseBBox.center=this.position,this.neighborsBBox.center=this.position}getNewHeading(s){this.futureHeading.set(0,0);let t=s.boidsQt.query(this.tooCloseBBox),e=s.boidsQt.query(this.neighborsBBox),i=new d(0,0);t.forEach(c=>{i.add(this.position).sub(c.position)});let o=new d(0,0);e.length>0&&(e.forEach(c=>{o.add(c.heading)}),o.divideScalar(e.length));let n=new d(0,0);e.length>0&&(e.forEach(c=>{n.add(c.position)}),n.divideScalar(e.length));let h=new d(0,0);this.position.x<s.worldArea.leftX()+this.params.obstacleRange&&(h.x+=this.params.turnFactor),this.position.x>s.worldArea.rightX()-this.params.obstacleRange&&(h.x-=this.params.turnFactor),this.position.y<s.worldArea.topY()+this.params.obstacleRange&&(h.y+=this.params.turnFactor),this.position.y>s.worldArea.bottomY()-this.params.obstacleRange&&(h.y-=this.params.turnFactor),s.obstacles.forEach(c=>{c.sqDistanceToPoint(this.position)}),this.futureHeading.addScaledVector(i,this.params.separationFactor),this.futureHeading.addScaledVector(o,this.params.alignmentFactor),this.futureHeading.addScaledVector(n,this.params.cohesionFactor),this.futureHeading.addScaledVector(h,this.params.turnFactor),this.futureHeading.clampLength(this.params.minSpeed,this.params.maxSpeed)}getPosition(){return this.position}updateParams(s){s.neighborRange&&(this.neighborsBBox.radius=s.neighborRange),s.protectedRange&&(this.tooCloseBBox.radius=s.protectedRange),this.params={...this.params,...s}}}class W{constructor(s,t,e,i){a(this,"QT_CAPACITY",3);a(this,"boidsQt");a(this,"boidsSprites",[]);a(this,"worldArea");a(this,"obstacles",[]);a(this,"curId",0);this.worldArea=new l(s,t,e,i),this.boidsQt=new u(this.worldArea,o=>o.getPosition(),this.QT_CAPACITY)}addBoid(s,t){let e=new U(this.curId++,s,t);this.boidsQt.push(e);let i=z();const o=new Q({color:16711680});let n=new V(i,o);n.position.x=s.x,n.position.y=s.y,n.rotateZ(t.angle()),this.boidsSprites.push(n)}updateHeadings(){this.boidsQt.queryAll().forEach(s=>{s.getNewHeading(this)})}move(){let s=new u(this.worldArea,t=>t.getPosition(),this.QT_CAPACITY);this.boidsQt.queryAll().forEach(t=>{t.move(),s.push(t),this.boidsSprites[t.id].position.x=t.getPosition().x,this.boidsSprites[t.id].position.y=t.getPosition().y,console.log({id:t.id,position:{x:t.getPosition().x,y:t.getPosition().y}})}),this.boidsQt=s}update(){this.updateHeadings(),this.move()}}function z(r,s){let t=new _;const e=0,i=0,o=Math.cos(Math.PI/6);let n=new d(e,i+1),h=new d(e-o,i-2),c=new d(e+o,i-2);return t.moveTo(n.x,n.y),t.lineTo(h.x,h.y),t.lineTo(c.x,c.y),new E(t)}function G(r,s,t,e=2){let i=new k;const o=r/s,n=s/e;let h=new L(-n*o/2,n*o/2,n/2,-n/2,1,1e3);h.position.z=10;let c=new j({canvas:t});return c.setSize(r,s),{scene:i,camera:h,renderer:c}}function O(r,s,t,e){const i=()=>{requestAnimationFrame(i),r({camera:e,scene:t,renderer:s}),s.render(t,e)};return i}function $(r){let s;return{c(){s=R("canvas")},l(t){s=H(t,"CANVAS",{}),I(s).forEach(w)},m(t,e){D(t,s,e),r[1](s)},p:b,i:b,o:b,d(t){t&&w(s),r[1](null)}}}function Z(r,s,t){let e,i,o,n,h,c,m;q(()=>{h=600,c=400,{camera:i,renderer:o,scene:n}=G(h,c,e),console.log("camera boundaries: ",{top:i.top,bottom:i.bottom,left:i.left,right:i.right}),m=new W(0,0,i.right-i.left,i.top-i.bottom);for(let f=0;f<100;++f){let S=Math.random()*(i.right-i.left)+i.left,A=Math.random()*(i.top-i.bottom)+i.bottom,x=new d(S,A);console.log(x),m.addBoid(x,new d(Math.random(),Math.random()))}n.add(...m.boidsSprites),O(f=>m.update(),o,n,i)()});function C(g){X[g?"unshift":"push"](()=>{e=g,t(0,e)})}return[e,C]}class it extends T{constructor(s){super(),F(this,s,Z,$,Y,{})}}export{it as component};
