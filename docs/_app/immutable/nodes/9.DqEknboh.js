var j=Object.defineProperty;var G=(a,e,t)=>e in a?j(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>(G(a,typeof e!="symbol"?e+"":e,t),t);import{s as D,n as P,o as W,v as U,b as q}from"../chunks/scheduler.iXXlly_q.js";import{S as $,i as C,e as S,t as Z,c as v,a as w,b as J,d as f,g as I,h as x,j as K,l as A,s as F,m as O,f as X,n as Y,o as V,p as H,q as R,u as T}from"../chunks/index.CGXjPJL2.js";import{V as d,M as tt,a as et,b as st,c as it,S as nt,O as at,W as rt,C as ot}from"../chunks/three.module.DzU_tVEa.js";import{a as Q}from"../chunks/utils.B7PvQ2PK.js";function M(a,e){const t=a.x-e.x,s=a.y-e.y;return t*t+s*s}class L{}class B extends L{constructor(t,s,i,n){super();c(this,"centerX");c(this,"centerY");c(this,"width");c(this,"height");this.centerX=t,this.centerY=s,this.width=i,this.height=n}static fromTopLeft(t,s,i,n){return new B(t+i/2,s+n/2,i,n)}leftX(){return this.centerX-this.width/2}rightX(){return this.centerX+this.width/2}topY(){return this.centerY-this.height/2}bottomY(){return this.centerY+this.height/2}debugDirections(){return{left:this.leftX(),right:this.rightX(),top:this.topY(),bottom:this.bottomY()}}contains(t){const s=t.x,i=t.y;return this.leftX()<=s&&this.rightX()>=s&&this.topY()<=i&&this.bottomY()>=i}intersects(t){if(t instanceof B)return!(this.leftX()>t.rightX()||t.leftX()>this.rightX()||this.topY()>t.bottomY()||t.topY()>this.bottomY());if(t instanceof _){if(this.contains(t.center))return!0;const s={x:Math.max(this.leftX(),Math.min(this.rightX(),t.center.x)),y:Math.max(this.topY(),Math.min(this.bottomY(),t.center.y))};return M(t.center,s)<t.radius*t.radius}Q(t)}closestBoundaryPointToPoint(t,s){s.x=Math.max(this.leftX(),Math.min(t.x,this.rightX())),s.y=Math.max(this.topY(),Math.min(t.y,this.bottomY()))}sqDistanceToPoint(t){const s={x:0,y:0};this.closestBoundaryPointToPoint(t,s);const i=t.x-s.x,n=t.y-s.y;return i*i+n*n}}class _ extends L{constructor(t,s){super();c(this,"center");c(this,"radius");this.center=t,this.radius=s}contains(t){return M(this.center,t)<this.radius*this.radius}intersects(t){if(t instanceof _){const s=this.radius+t.radius,i=s*s;return M(this.center,t.center)<i}if(t instanceof B)return t.intersects(this);Q(t)}closestBoundaryPointToPoint(t,s){const i=t.x-this.center.x,n=t.y-this.center.y,r=Math.sqrt(i*i+n*n);r<=1e-4&&(s.x=this.center.x,s.y=this.center.y);const l=this.radius/r;s.x=this.center.x+t.x*l,s.y=this.center.y+t.y*l}sqDistanceToPoint(t){const s=t.x-this.center.x,i=t.y-this.center.y,n=s*s+i*i;return Math.pow(Math.sqrt(n)-this.radius,2)}}class ct{}class E extends ct{constructor(t){super();c(this,"elements",[]);c(this,"accessFunc");this.accessFunc=t}push(t){this.elements.push(t)}query(t){return this.elements.filter(s=>t.contains(this.accessFunc(s)))}queryAll(){return this.elements}rebalance(){}}const ht={maxSpeed:3,minSpeed:2,neighborRange:20,protectedRange:2,obstacleRange:50,cohesionFactor:5e-4,separationFactor:.05,alignmentFactor:.05,turnFactor:.25,speedScale:1};class lt{constructor(e,t,s,i={}){c(this,"tooCloseBBox");c(this,"neighborsBBox");c(this,"position");c(this,"heading");c(this,"futureHeadingOffset");c(this,"params");c(this,"id");this.id=e,this.position=t,this.heading=s,this.futureHeadingOffset=s.clone(),this.params={...ht,...i},this.tooCloseBBox=new _(t,this.params.protectedRange),this.neighborsBBox=new _(t,this.params.neighborRange)}move(e){this.heading.copy(this.futureHeadingOffset).clampLength(this.params.minSpeed,this.params.maxSpeed).multiplyScalar(this.params.speedScale),this.position.addScaledVector(this.heading,e*60),this.tooCloseBBox.center=this.position,this.neighborsBBox.center=this.position}calculateNewHeading(e){this.futureHeadingOffset.copy(this.heading);let t=e.boidsQt.query(this.tooCloseBBox),s=e.boidsQt.query(this.neighborsBBox).filter(o=>!t.includes(o)),i=new d(0,0);t.forEach(o=>{i.add(this.position).sub(o.position)});let n=new d(0,0);s.length>0&&(s.forEach(o=>{n.add(o.heading)}),n.divideScalar(s.length));let r=new d(0,0);s.length>0&&(s.forEach(o=>{r.add(o.position)}),r.divideScalar(s.length));let l=new d;e.obstacles.forEach(o=>{let p=this.position.distanceToSquared(o.position),g=Math.pow(p,-o.inverseDistance)*o.attractiveStrength,h=this.position.clone().sub(o.position);l.addScaledVector(h,-g)}),this.futureHeadingOffset.addScaledVector(i,this.params.separationFactor),this.futureHeadingOffset.addScaledVector(n,this.params.alignmentFactor),this.futureHeadingOffset.addScaledVector(r,this.params.cohesionFactor),this.futureHeadingOffset.add(l),this.futureHeadingOffset.clampLength(this.params.minSpeed,this.params.maxSpeed)}getPosition(){return this.position}getVelocity(){return this.heading}updateParams(e){e.neighborRange&&(this.neighborsBBox.radius=e.neighborRange),e.protectedRange&&(this.tooCloseBBox.radius=e.protectedRange),this.params={...this.params,...e}}}class dt{constructor(e,t,s,i){c(this,"QT_CAPACITY",3);c(this,"boidsQt");c(this,"boidsSprites",[]);c(this,"worldArea");c(this,"obstacles",[]);c(this,"curId",0);this.worldArea=new B(e,t,s,i),this.boidsQt=new E(n=>n.getPosition()),this.addObstacle({position:new d(e,t),attractiveStrength:6e-8,inverseDistance:-1}),this.addObstacle({position:new d(e-s/6,t),attractiveStrength:-1e-9,inverseDistance:1}),this.addObstacle({position:new d(e+s/6,t),attractiveStrength:-1e-9,inverseDistance:1})}addBoid(e,t){let s=new lt(this.curId++,e,t);this.boidsQt.push(s);let i=ut();const n=new tt({color:16777215,opacity:.6,transparent:!0});let r=new et(i,n);r.position.x=e.x,r.position.y=e.y,r.rotateZ(t.angle()),this.boidsSprites.push(r)}updateHeadings(){this.boidsQt.queryAll().forEach(e=>{e.calculateNewHeading(this)})}move(e){this.boidsQt.queryAll().forEach(t=>{t.move(e),this.boidsSprites[t.id].position.x=t.getPosition().x,this.boidsSprites[t.id].position.y=t.getPosition().y,this.boidsSprites[t.id].rotation.z=t.getVelocity().angle()}),this.boidsQt.rebalance()}update(e){this.updateHeadings(),this.move(e)}addObstacle(e){this.obstacles.push(e)}destroy(){this.boidsQt=new E(e=>e.getPosition()),this.boidsSprites=[]}}function ut(){let a=new st;const e=-.8,t=Math.sin(Math.acos(e)),s=1;let i=new d(1,0).multiplyScalar(s),n=new d(e,t).multiplyScalar(s),r=new d(e,-t).multiplyScalar(s);return a.moveTo(i.x,i.y),a.lineTo(n.x,n.y),a.lineTo(r.x,r.y),new it(a)}function pt(a,e,t,s=2){let i=new nt;const n=a/e,r=e/s;let l=new at(-r*n/2,r*n/2,r/2,-r/2,1,1e3);l.position.z=10;let o=new rt({canvas:t});return o.setSize(a,e),{scene:i,camera:l,renderer:o}}function mt(a,e,t,s,i){const n=()=>{requestAnimationFrame(n);let r=i.getDelta();a({camera:s,scene:t,renderer:e,deltatime:r}),e.render(t,s)};return n}class ft extends ${constructor(e){super(),C(this,e,null,null,D,{})}}class gt{constructor(e){c(this,"capacity");c(this,"head",0);c(this,"tail",0);c(this,"array");c(this,"occupancy",0);this.capacity=e,this.array=new Array(e)}push(e){this.occupancy===this.capacity&&(this.occupancy-=1,this.head=(this.head+1)%this.capacity),this.array[this.tail]=e,this.tail=(this.tail+1)%this.capacity,this.occupancy+=1}pop(){if(this.occupancy===0)return null;const e=this.array[this.head];return this.head=(this.head+1)%this.capacity,this.occupancy-=1,e}peek(){return this.occupancy===0?null:this.array[this.head]}map(e){let t=this.head,s=new Array(this.occupancy);for(let i=0;i<this.occupancy;++i)s.push(e(this.array[t])),t=(t+1)%this.capacity;return s}reduce(e,t){let s=this.head;for(let i=0;i<this.occupancy;++i)t=e(t,this.array[s]),s=(s+1)%this.capacity;return t}toArray(){return[...this.array.slice(this.head),...this.array.slice(void 0,this.tail)]}}class yt extends gt{constructor(){super(...arguments);c(this,"_sum",0)}mean(){return this.occupancy>0?this.sum()/this.occupancy:null}sum(){return this.reduce((t,s)=>t+s,0)}}function bt(a){let e,t=Math.round(1/(a[0].mean()??-1))+"",s;return{c(){e=S("div"),s=Z(t)},l(i){e=v(i,"DIV",{});var n=w(e);s=J(n,t),n.forEach(f)},m(i,n){I(i,e,n),x(e,s)},p(i,[n]){n&1&&t!==(t=Math.round(1/(i[0].mean()??-1))+"")&&K(s,t)},i:P,o:P,d(i){i&&f(e)}}}function xt(a,e,t){let s=new yt(10);function i(n){s.push(n),t(0,s)}return[s,i]}class St extends ${constructor(e){super(),C(this,e,xt,bt,D,{pushDeltatime:1})}get pushDeltatime(){return this.$$.ctx[1]}}function vt(a){let e,t,s,i,n,r,l,o,p,g={};return s=new St({props:g}),a[2](s),o=new ft({}),{c(){e=S("div"),t=S("div"),A(s.$$.fragment),i=F(),n=S("div"),r=S("canvas"),l=F(),A(o.$$.fragment),this.h()},l(h){e=v(h,"DIV",{class:!0});var m=w(e);t=v(m,"DIV",{class:!0});var y=w(t);O(s.$$.fragment,y),y.forEach(f),i=X(m),n=v(m,"DIV",{});var u=w(n);r=v(u,"CANVAS",{}),w(r).forEach(f),l=X(u),O(o.$$.fragment,u),u.forEach(f),m.forEach(f),this.h()},h(){Y(t,"class","absolute select-none text-white"),Y(e,"class","relative")},m(h,m){I(h,e,m),x(e,t),V(s,t,null),x(e,i),x(e,n),x(n,r),a[3](r),x(n,l),V(o,n,null),p=!0},p(h,[m]){const y={};s.$set(y)},i(h){p||(H(s.$$.fragment,h),H(o.$$.fragment,h),p=!0)},o(h){R(s.$$.fragment,h),R(o.$$.fragment,h),p=!1},d(h){h&&f(e),a[2](null),T(s),a[3](null),T(o)}}}const wt=200;function Bt(a,e,t){let s,i,n,r,l,o,p,g,h;W(()=>{p=1200,g=600,{camera:i,renderer:n,scene:r}=pt(p,g,s,2),console.log("camera boundaries: ",{top:i.top,bottom:i.bottom,left:i.left,right:i.right}),h=new dt(0,0,i.right-i.left,i.top-i.bottom);for(let b=0;b<wt;++b){let k=Math.random()*(i.right-i.left)+i.left,N=Math.random()*(i.top-i.bottom)+i.bottom,z=new d(k,N);h.addBoid(z,new d(Math.random(),Math.random()))}r.add(...h.boidsSprites),l=new ot,mt(b=>{b.deltatime>0&&(o.pushDeltatime(b.deltatime),h.update(Math.min(b.deltatime,1/15)))},n,r,i,l)()}),U(()=>{h&&h.destroy(),r&&r.clear(),l&&l.stop()});function m(u){q[u?"unshift":"push"](()=>{o=u,t(1,o)})}function y(u){q[u?"unshift":"push"](()=>{s=u,t(0,s)})}return[s,o,m,y]}class Pt extends ${constructor(e){super(),C(this,e,Bt,vt,D,{})}}export{Pt as component};
