var Y=Object.defineProperty;var F=(a,e,t)=>e in a?Y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>(F(a,typeof e!="symbol"?e+"":e,t),t);import{s as P,n as H,o as T,u as R,b as V}from"../chunks/scheduler.BJuhaVyq.js";import{S as q,i as C,e as S,s as Q,l as $,c as w,a as v,d as y,f as E,m as I,g as L,h as B,o as k,p as z,q as N,u as G}from"../chunks/index.Do8Wf1tJ.js";import{V as d,M as W,a as j,b as U,c as Z,S as J,O as K,W as tt,C as et}from"../chunks/three.module.DzU_tVEa.js";import{a as _}from"../chunks/utils.B7PvQ2PK.js";function x(a,e){const t=a.x-e.x,s=a.y-e.y;return t*t+s*s}class A{}class m extends A{constructor(t,s,i,n){super();r(this,"centerX");r(this,"centerY");r(this,"width");r(this,"height");this.centerX=t,this.centerY=s,this.width=i,this.height=n}static fromTopLeft(t,s,i,n){return new m(t+i/2,s+n/2,i,n)}leftX(){return this.centerX-this.width/2}rightX(){return this.centerX+this.width/2}topY(){return this.centerY-this.height/2}bottomY(){return this.centerY+this.height/2}debugDirections(){return{left:this.leftX(),right:this.rightX(),top:this.topY(),bottom:this.bottomY()}}contains(t){const s=t.x,i=t.y;return this.leftX()<=s&&this.rightX()>=s&&this.topY()<=i&&this.bottomY()>=i}intersects(t){if(t instanceof m)return!(this.leftX()>t.rightX()||t.leftX()>this.rightX()||this.topY()>t.bottomY()||t.topY()>this.bottomY());if(t instanceof p){if(this.contains(t.center))return!0;const s={x:Math.max(this.leftX(),Math.min(this.rightX(),t.center.x)),y:Math.max(this.topY(),Math.min(this.bottomY(),t.center.y))};return x(t.center,s)<t.radius*t.radius}_(t)}closestBoundaryPointToPoint(t,s){s.x=Math.max(this.leftX(),Math.min(t.x,this.rightX())),s.y=Math.max(this.topY(),Math.min(t.y,this.bottomY()))}sqDistanceToPoint(t){const s={x:0,y:0};this.closestBoundaryPointToPoint(t,s);const i=t.x-s.x,n=t.y-s.y;return i*i+n*n}}class p extends A{constructor(t,s){super();r(this,"center");r(this,"radius");this.center=t,this.radius=s}contains(t){return x(this.center,t)<this.radius*this.radius}intersects(t){if(t instanceof p){const s=this.radius+t.radius,i=s*s;return x(this.center,t.center)<i}if(t instanceof m)return t.intersects(this);_(t)}closestBoundaryPointToPoint(t,s){const i=t.x-this.center.x,n=t.y-this.center.y,o=Math.sqrt(i*i+n*n);o<=1e-4&&(s.x=this.center.x,s.y=this.center.y);const c=this.radius/o;s.x=this.center.x+t.x*c,s.y=this.center.y+t.y*c}sqDistanceToPoint(t){const s=t.x-this.center.x,i=t.y-this.center.y,n=s*s+i*i;return Math.pow(Math.sqrt(n)-this.radius,2)}}class st{}class M extends st{constructor(t){super();r(this,"elements",[]);r(this,"accessFunc");this.accessFunc=t}push(t){this.elements.push(t)}query(t){return this.elements.filter(s=>t.contains(this.accessFunc(s)))}queryAll(){return this.elements}rebalance(){}}const it={maxSpeed:3,minSpeed:2,neighborRange:20,protectedRange:2,obstacleRange:50,cohesionFactor:5e-4,separationFactor:.05,alignmentFactor:.05,turnFactor:.25,speedScale:1};class nt{constructor(e,t,s,i={}){r(this,"tooCloseBBox");r(this,"neighborsBBox");r(this,"position");r(this,"heading");r(this,"futureHeadingOffset");r(this,"params");r(this,"id");this.id=e,this.position=t,this.heading=s,this.futureHeadingOffset=s.clone(),this.params={...it,...i},this.tooCloseBBox=new p(t,this.params.protectedRange),this.neighborsBBox=new p(t,this.params.neighborRange)}move(e){this.heading.copy(this.futureHeadingOffset).clampLength(this.params.minSpeed,this.params.maxSpeed).multiplyScalar(this.params.speedScale),this.position.addScaledVector(this.heading,e*60),this.tooCloseBBox.center=this.position,this.neighborsBBox.center=this.position}calculateNewHeading(e){this.futureHeadingOffset.copy(this.heading);let t=e.boidsQt.query(this.tooCloseBBox),s=e.boidsQt.query(this.neighborsBBox).filter(h=>!t.includes(h)),i=new d(0,0);t.forEach(h=>{i.add(this.position).sub(h.position)});let n=new d(0,0);s.length>0&&(s.forEach(h=>{n.add(h.heading)}),n.divideScalar(s.length));let o=new d(0,0);s.length>0&&(s.forEach(h=>{o.add(h.position)}),o.divideScalar(s.length));let c=new d;e.obstacles.forEach(h=>{let f=this.position.distanceToSquared(h.position),l=Math.pow(f,-h.inverseDistance)*h.attractiveStrength,g=this.position.clone().sub(h.position);c.addScaledVector(g,-l)}),this.futureHeadingOffset.addScaledVector(i,this.params.separationFactor),this.futureHeadingOffset.addScaledVector(n,this.params.alignmentFactor),this.futureHeadingOffset.addScaledVector(o,this.params.cohesionFactor),this.futureHeadingOffset.add(c),this.futureHeadingOffset.clampLength(this.params.minSpeed,this.params.maxSpeed)}getPosition(){return this.position}getVelocity(){return this.heading}updateParams(e){e.neighborRange&&(this.neighborsBBox.radius=e.neighborRange),e.protectedRange&&(this.tooCloseBBox.radius=e.protectedRange),this.params={...this.params,...e}}}class ot{constructor(e,t,s,i){r(this,"QT_CAPACITY",3);r(this,"boidsQt");r(this,"boidsSprites",[]);r(this,"worldArea");r(this,"obstacles",[]);r(this,"curId",0);this.worldArea=new m(e,t,s,i),this.boidsQt=new M(n=>n.getPosition()),this.addObstacle({position:new d(e,t),attractiveStrength:6e-8,inverseDistance:-1}),this.addObstacle({position:new d(e-s/6,t),attractiveStrength:-1e-9,inverseDistance:1}),this.addObstacle({position:new d(e+s/6,t),attractiveStrength:-1e-9,inverseDistance:1})}addBoid(e,t){let s=new nt(this.curId++,e,t);this.boidsQt.push(s);let i=at();const n=new W({color:16777215,opacity:.6,transparent:!0});let o=new j(i,n);o.position.x=e.x,o.position.y=e.y,o.rotateZ(t.angle()),this.boidsSprites.push(o)}updateHeadings(){this.boidsQt.queryAll().forEach(e=>{e.calculateNewHeading(this)})}move(e){this.boidsQt.queryAll().forEach(t=>{t.move(e),this.boidsSprites[t.id].position.x=t.getPosition().x,this.boidsSprites[t.id].position.y=t.getPosition().y,this.boidsSprites[t.id].rotation.z=t.getVelocity().angle()}),this.boidsQt.rebalance()}update(e){this.updateHeadings(),this.move(e)}addObstacle(e){this.obstacles.push(e)}destroy(){this.boidsQt=new M(e=>e.getPosition()),this.boidsSprites=[]}}function at(){let a=new U;const e=-.8,t=Math.sin(Math.acos(e)),s=1;let i=new d(1,0).multiplyScalar(s),n=new d(e,t).multiplyScalar(s),o=new d(e,-t).multiplyScalar(s);return a.moveTo(i.x,i.y),a.lineTo(n.x,n.y),a.lineTo(o.x,o.y),new Z(a)}function rt(a,e,t,s=2){let i=new J;const n=a/e,o=e/s;let c=new K(-o*n/2,o*n/2,o/2,-o/2,1,1e3);c.position.z=10;let h=new tt({canvas:t});return h.setSize(a,e),{scene:i,camera:c,renderer:h}}function ct(a,e,t,s,i){const n=()=>{requestAnimationFrame(n);let o=i.getDelta();a({camera:s,scene:t,renderer:e,deltatime:o}),e.render(t,s)};return n}class ht extends q{constructor(e){super(),C(this,e,null,null,P,{})}}function dt(a){let e,t,s,i,n;return i=new ht({}),{c(){e=S("div"),t=S("canvas"),s=Q(),$(i.$$.fragment)},l(o){e=w(o,"DIV",{});var c=v(e);t=w(c,"CANVAS",{}),v(t).forEach(y),s=E(c),I(i.$$.fragment,c),c.forEach(y)},m(o,c){L(o,e,c),B(e,t),a[1](t),B(e,s),k(i,e,null),n=!0},p:H,i(o){n||(z(i.$$.fragment,o),n=!0)},o(o){N(i.$$.fragment,o),n=!1},d(o){o&&y(e),a[1](null),G(i)}}}const lt=200;function ut(a,e,t){let s,i,n,o,c,h,f,l;T(()=>{h=1200,f=600,{camera:i,renderer:n,scene:o}=rt(h,f,s,2),console.log("camera boundaries: ",{top:i.top,bottom:i.bottom,left:i.left,right:i.right}),l=new ot(0,0,i.right-i.left,i.top-i.bottom);for(let u=0;u<lt;++u){let D=Math.random()*(i.right-i.left)+i.left,O=Math.random()*(i.top-i.bottom)+i.bottom,X=new d(D,O);l.addBoid(X,new d(Math.random(),Math.random()))}o.add(...l.boidsSprites),c=new et,ct(u=>{u.deltatime>0&&(console.log(u.deltatime),l.update(Math.min(u.deltatime,1/15)))},n,o,i,c)()}),R(()=>{l&&l.destroy(),o&&o.clear(),c&&c.stop()});function g(b){V[b?"unshift":"push"](()=>{s=b,t(0,s)})}return[s,g]}class yt extends q{constructor(e){super(),C(this,e,ut,dt,P,{})}}export{yt as component};
